sf::st_make_grid(cellsize = rep(resolution, 2)) |>
stars::st_as_stars(dx = resolution, dy = resolution) |>
dplyr::mutate(
!!!setNames(rep(NA, length(dat_cols)), dat_cols)
) |>
dplyr::select(-1) |>
dplyr::mutate(
dplyr::across(dplyr::any_of(dat_cols), ~x[[dplyr::cur_column()]])
)
x$csquares
length(x$csquares)
grd <-
x |>
sf::st_make_grid(cellsize = rep(resolution, 2)) |>
stars::st_as_stars(dx = resolution, dy = resolution) |>
dplyr::mutate(
!!!setNames(rep(NA, length(dat_cols)), dat_cols)
) |>
dplyr::select(-1)
grd
x
st_as_stars.csquares(x$csquares)
sf::st_crs(x)
st_as_stars.csquares(x$csquares)
st_as_stars.csquares(x$csquares, crs = sf::st_crs(x))
st_as_stars.csquares(x$csquares, resolution = resolution)
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
x <-
x |>
sf::st_cast("POLYGON") |>
suppressWarnings()
dat_cols <- x |> sf::st_drop_geometry() |> colnames()
st_as_stars.csquares(x$csquares, resolution = resolution)
x$csquares
st_as_sf.csquares(x$csquares, resolution = resolution)
st_as_sf.csquares(x$csquares)
x |> sf::st_coordinates()
x |> sf::st_centroid()
x |> sf::st_centroid() |> suppressWarnings()
x |> sf::st_centroid() |> suppressWarnings() |>
stars::st_as_stars()
x |> sf::st_centroid() |> suppressWarnings() |>
stars::st_as_stars(dx = resolution, dy = resolution)
x |> sf::st_centroid() |> suppressWarnings() |>
stars::st_stars(dx = resolution, dy = resolution)
x |> sf::st_centroid() |> suppressWarnings() |>
stars::st_rasterize(dx = resolution, dy = resolution)
x |>
stars::st_rasterize(dx = resolution, dy = resolution)
x |>
stars::st_rasterize()
x |>
stars::st_rasterize(dx = resolution, dy = resolution)
x
x |>
stars::st_rasterize(dx = resolution, dy = resolution)
x |>
sf::st_cast("POLYGON") |>
suppressWarnings() |>
stars::st_rasterize(dx = resolution, dy = resolution)
x |>
sf::st_cast("POLYGON") |>
suppressWarnings() |>
stars::st_rasterize(dx = resolution, dy = resolution)
x <-
x |>
sf::st_cast("POLYGON") |>
suppressWarnings() |>
stars::st_rasterize(dx = resolution, dy = resolution)
x |>
dplyr::mutate(
!!.by := as_csquares(sf::st_coordinates(x))
)
x |>
dplyr::mutate(
!!.by := as_csquares(sf::st_coordinates(x), resolution = resolution)
)
x <- x |>
dplyr::mutate(
!!.by := as_csquares(sf::st_coordinates(x), resolution = resolution)
)
x$csquares
library(csquares)
summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x |>
# sf::st_cast("POLYGON") |>
# suppressWarnings() |>
stars::st_rasterize(dx = resolution, dy = resolution)
x <-
x |>
stars::st_rasterize(dx = resolution, dy = resolution)
x <- x |>
dplyr::mutate(
!!.by := as_csquares(sf::st_coordinates(x), resolution = resolution)
)
library(csquares)
summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
temp<-summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
temp
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
ggplot2::ggplot() +
stars::geom_stars(data=grd, ggplot2::aes(fill = dummy))
ggplot2::ggplot() +
stars::geom_stars(data=grd2, ggplot2::aes(fill = dummy))
library(csquares)
?stars::st_downsample()
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
stars::st_res(x)
stars::st_res(x) |> identical()
crs
crs$input
all(resolution[1] == resolution)
resolution <- stars::st_res(x)
all(resolution[1] == resolution)
resolution <- resolution[[1]]
resolution
resolution
res <- .check_resolution(resolution)
res
log10(res)
log10(res) + tiers_down/2
10^(log10(res) + tiers_down/2)
.check_resolution(10^(log10(res) + tiers_down/2))
10^(log10(res) + tiers_down/2) |>
.check_resolution() |>
suppressWarnings()
new_res <-
10^(log10(res) + tiers_down/2) |>
.check_resolution() |>
suppressWarnings()
?st_res
new_res
new_res/res
stars::st_downsample(x, new_res/res)
stars::st_downsample(x, new_res/res, dx = new_res, dy = new_res)
x
stars::st_downsample(x, 4.5)
stars::st_downsample(x, 4.5) |> stars::st_res()
stars::st_downsample(x, new_res/res - 0.5)
temp <- stars::st_downsample(x, new_res/res - 0.5)
temp
temp$csquares
temp$dummy
temp <- stars::st_downsample(x, new_res/res - 0.5, FUN = function(z){
browser();z})
z
z
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
x[[.by]]
range(x[[.by]])
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
class(x)
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
grd <- st_as_sf.csquares(x)
grd <- st_as_sf.csquares(x[[.by]])
grd
grd <- st_as_sf.csquares(x[[.by]], resolution = resolution)
grd <- st_as_sf.csquares(x[[.by]])
grd
grd <- st_as_stars.csquares(x[[.by]], resolution = resolution)
x[[.by]]
grd <- st_as_stars.csquares(x, resolution = resolution)
grd
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE)
grd
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
rename(!.by := "csquares")
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
dplyr::rename(!.by := "csquares")
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
dplyr::rename(!!.by := "csquares")
grd
.by
x |> sf::st_drop_geometry()
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
dplyr::rename(!!.by := "csquares") |>
dplyr::left_join(x |> sf::st_drop_geometry(), by = .by)
?sf::st_join
attributes(grd)
grd[,1]
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
dplyr::rename(!!.by := "csquares") |>
dplyr::left_join(x |> sf::st_drop_geometry(), by = .by)
grd <- st_as_stars.csquares(x, resolution = resolution, add_csquares = TRUE) |>
dplyr::rename(!!.by := "csquares")
grd
ret <- grd |>
.to_df() |>
dplyr::left_join(x |> sf::st_drop_geometry(), by = .b)
ret <- grd |>
.to_df() |>
dplyr::left_join(x |> sf::st_drop_geometry(), by = .by)
ret
.set_dim(ret, dim(x))
dim(x)
dim(grd)
stars::st_dimensions(grd)
stars::st_as_stars(.set_dim(ret, dim(grd)),
dimensions = stars::st_dimensions(grd))
library(csquares)
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
grd2
ggplot2::ggplot() +
stars::geom_stars(data=grd, ggplot2::aes(fill = dummy))
ggplot2::ggplot() +
stars::geom_stars(data=grd2, ggplot2::aes(fill = dummy))
st_as_stars.csquares(st_bbox(c(xmin = -180, ymin = -90, xmax = 180, ymax = 90), crs = 4326))
st_as_stars.csquares(sf::st_bbox(c(xmin = -180, ymin = -90, xmax = 180, ymax = 90), crs = 4326))
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
x|>sf::st_bbox()
ggplot()+geom_sf(data=x)
library(ggplot2)
ggplot()+geom_sf(data=x)
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
library(csquares)
x
x$csquares
View(x)
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
x
x1
y1
last_digit <- x[1] == (l10 + 1)
if (last_digit) fun <- round else fun <- floor
x <-
(fun((10^(x - 1)) * abs(cbind(y1, x1))) %% 10)
x
apply(x, 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
apply(cbind(1,1), 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
apply(expand.grid(0:4, 0:4), 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
expand.grid(0:4, 0:4)
apply(expand.grid(0:4, 5:9), 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
apply(expand.grid(5:9, 5:9), 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
apply(expand.grid(5:9, 0:4), 1, function(z) 1 + floor(z[[1]]/5) + 2*floor(z[[2]]/5))
apply(expand.grid(5:9, 0:4), 1, function(z) 1 + 2*floor(z[[1]]/5) - floor(z[[2]]/5))
apply(expand.grid(5:9, 5:9), 1, function(z) 1 + 2*floor(z[[1]]/5) - floor(z[[2]]/5))
apply(expand.grid(5:9, 5:9), 1, function(z) 1 + 2*floor(z[[2]]/5 - floor(z[[1]]/5)))
bitwShiftR(1:3,1)
bitwShiftR(1:4,1)
bitwShiftR(1:4,-1)
bitwShiftR(1:4,1)
bitwShiftL(1:4,1)
apply(expand.grid(5:9, 5:9), 1, function(z) (3 - 2*(floor(z[[2]]/5) - 1) + floor(z[[1]]/5)) - 2)
apply(expand.grid(5:9, 5:9), 1, function(z) (2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5)) - 1)
apply(expand.grid(0:4, 5:9), 1, function(z) (2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5)) - 1)
apply(expand.grid(0:4, 0:4), 1, function(z) (2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5)) - 1)
apply(expand.grid(5:9, 0:4), 1, function(z) (2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5)) - 1)
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
grd2
ggplot2::ggplot() +
stars::geom_stars(data=grd, ggplot2::aes(fill = dummy))
ggplot2::ggplot() +
stars::geom_stars(data=grd2, ggplot2::aes(fill = dummy))
st_as_stars.csquares(sf::st_bbox(c(xmin = -180, ymin = -90, xmax = 180, ymax = 90), crs = 4326))
temp  <- st_as_stars.csquares(nc, add_csquares = TRUE, resolution = 1)
temp2 <- c(temp$csquares)|> st_as_sf.csquares()
temp3 <- temp |> sf::st_coordinates() |> sf::st_as_sf(coords = c("x", "y"), crs = 4326)
ggplot2::ggplot() +
stars::geom_stars(data=temp)+
ggplot2::geom_sf(data = temp2) +
ggplot2::geom_sf(data = temp3)
temp3 |> as_csquares(1) |> st_as_sf.csquares() |> plot()
temp4 <-
st_as_sf.csquares("7500:110:3|7500:110:1|1500:110:3|1500:110:1")
as_csquares(temp4)
crds <-
cbind(x = runif(100, -180, 180), y = runif(100, -90, 90))
crds_sf <- crds |> as_csquares(10) |> st_as_sf.csquares()
crds_sf2 <- crds |> apply(1, st_point, simplify = F) |> dplyr::tibble() |>
dplyr::rename("geom" = 1) |> st_as_sf(crs = 4326)
crds_sf2 <- crds |> apply(1, sf::st_point, simplify = F) |> dplyr::tibble() |>
dplyr::rename("geom" = 1) |> sd::st_as_sf(crs = 4326)
crds_sf2 <- crds |> apply(1, sf::st_point, simplify = F) |> dplyr::tibble() |>
dplyr::rename("geom" = 1) |> sf::st_as_sf(crs = 4326)
temp <- st_overlaps(crds_sf, crds_sf2)
temp <- sf::st_overlaps(crds_sf, crds_sf2)
temp <- sf::st_intersection(crds_sf2, crds_sf)
sf::st_within(crds_sf2, crds_sf)
ggplot(crds_sf) +
geom_sf() +
coord_sf(expand = F) +
geom_point(data = dplyr::as_tibble(crds), aes(x = x, y = y), col = "red")
q_fun <- \(x,y) 1 + 2 * (((1 - sign(y))/2) + (1 - sign(x)))
q_fun( 1, 1)
q_fun( 1,-1)
q_fun(-1,-1)
q_fun(-1, 1)
x <- c(1, 1, -1, -1)
y <- c(1, -1, -1, 1)
((x < 0) + 1) + 2*((y < 0) + 1)
(1 + 1*(x < 0))*(1 + 2*xor(x > 0,  y > 0))
library(csquares)
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
x
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
x
cbind(
apply(x, 1, function(z) 2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5) - 1), x)
temp<-cbind(
apply(x, 1, function(z) 2*(floor(z[[2]]/5) + 1) + floor(z[[1]]/5) - 1), x)|> as.data.frame()
View(temp)
x <- cbind(
apply(x, 1, function(z) 2*(floor(z[[1]]/5) + 1) + floor(z[[2]]/5) - 1), x)
temp<-x|>as.data.frame()
View(temp)
library(csquares)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
ggplot2::ggplot() +
stars::geom_stars(data=grd, ggplot2::aes(fill = dummy))
ggplot2::ggplot() +
stars::geom_stars(data=grd2, ggplot2::aes(fill = dummy))
temp  <- st_as_stars.csquares(nc, add_csquares = TRUE, resolution = 1)
temp2 <- c(temp$csquares)|> st_as_sf.csquares()
temp3 <- temp |> sf::st_coordinates() |> sf::st_as_sf(coords = c("x", "y"), crs = 4326)
ggplot2::ggplot() +
stars::geom_stars(data=temp)+
ggplot2::geom_sf(data = temp2) +
ggplot2::geom_sf(data = temp3)
temp3 |> as_csquares(1) |> st_as_sf.csquares() |> plot()
temp4 <-
st_as_sf.csquares("7500:110:3|7500:110:1|1500:110:3|1500:110:1")
as_csquares(temp4)
crds <-
cbind(x = runif(100, -180, 180), y = runif(100, -90, 90))
crds_sf <- crds |> as_csquares(10) |> st_as_sf.csquares()
crds_sf2 <- crds |> apply(1, sf::st_point, simplify = F) |> dplyr::tibble() |>
dplyr::rename("geom" = 1) |> sf::st_as_sf(crs = 4326)
temp <- sf::st_overlaps(crds_sf, crds_sf2)
temp <- sf::st_intersection(crds_sf2, crds_sf)
sf::st_within(crds_sf2, crds_sf)
ggplot(crds_sf) +
geom_sf() +
coord_sf(expand = F) +
geom_point(data = dplyr::as_tibble(crds), aes(x = x, y = y), col = "red")
orca |>
st_as_sf.csquares("csquares") |>
st_transform(crs = "+proj=natearth2 +lon_0=0 +x_0=0 +y_0=0") |>
ggplot() +
geom_sf(aes(fill = orcinus_orca)) +
coord_sf(expand = FALSE)
nc  <- sf::st_read(system.file("shape/nc.shp", package = "sf"))
library(sf)
orca |>
st_as_sf.csquares("csquares") |>
st_transform(crs = "+proj=natearth2 +lon_0=0 +x_0=0 +y_0=0") |>
ggplot() +
geom_sf(aes(fill = orcinus_orca)) +
coord_sf(expand = FALSE)
nc  <- sf::st_read(system.file("shape/nc.shp", package = "sf"))
rst <- st_as_stars.csquares(nc, add_csquares = TRUE)
ggplot2::ggplot() +
stars::geom_stars(data = rst) +
ggplot2::geom_sf(data = nc)
grd <-
sf::st_bbox(c(xmin = 4.0, xmax = 6.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
grd[["dummy"]] <- grd |> dim() |> prod() |> rnorm()
grd2 <- summarise.csquare(
grd,
dummy = mean(.data$dummy),
.by = "csquares"
)
ggplot2::ggplot() +
stars::geom_stars(data=grd, ggplot2::aes(fill = dummy))
ggplot2::ggplot() +
stars::geom_stars(data=grd2, ggplot2::aes(fill = dummy))
grd2
st_bbox(c(xmin = 5.0, xmax = 5.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
st_bbox(c(xmin = 5.0, xmax = 5.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE) |>plot()
temp<-st_bbox(c(xmin = 5.0, xmax = 5.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE) |>
temp<-st_bbox(c(xmin = 5.0, xmax = 5.5, ymin = 52.5, ymax = 53), crs = 4326) |>
st_as_stars.csquares(resolution = 0.1, add_csquares = TRUE)
ggplot() +geom_stars(data=temp)
ggplot2::ggplot() +stars::geom_stars(data=temp)
library(csquares)
library(csquares)
